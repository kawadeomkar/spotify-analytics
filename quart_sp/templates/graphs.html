<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Spotify Analytics Graphs</title>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"
            integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
            crossorigin="anonymous"></script>
    <script src="https://d3js.org/d3.v6.min.js"></script>
</head>
<body>
<div id="saved_tracks_monthly"></div>
<div id="genre_count_stacked_monthly"></div>
<script>
    // ****** LINE CHART *********
    // set the dimensions and margins of the graph
    var margin = {top: 10, right: 30, bottom: 30, left: 60},
        width = 460 - margin.left - margin.right,
        height = 400 - margin.top - margin.bottom;

    // append the svg object to the body of the page
    var svg = d3.select("#saved_tracks_monthly")
        .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform",
            "translate(" + margin.left + "," + margin.top + ")");


    var maa_df = JSON.parse('{{ maa_df | tojson | safe }}');
    maa_df.forEach(function (data) {
        data.date = d3.timeParse("%m-%Y")(data.date)
    })

    var x = d3.scaleTime().domain(d3.extent(maa_df.map(function (item) {
        console.log(item.date);
        return item.date;
    }))).range([0, width]);


    svg.append("g")
        .attr("transform", "translate(0," + height + ")")
        .call(d3.axisBottom(x)
                .ticks(maa_df.length)
            //.tickFormat(d=>d3.timeFormat("%a %d")(d)) TODO: time format
        );

    const max = d3.max(maa_df, function (item) {
        return item.count;
    })

    var y = d3.scaleLinear()
        .domain([0, max])
        .range([height, 0]);

    svg.append("g")
        .call(d3.axisLeft(y));

    svg.append("linearGradient")
        .attr("id", "line-gradient")
        .attr("gradientUnits", "userSpaceOnUse")
        .attr("x1", 0)
        .attr("y1", y(0))
        .attr("x2", 0)
        .attr("y2", y(max))
        .selectAll("stop")
        .data([
            {offset: "0%", color: "blue"},
            {offset: "100%", color: "red"}
        ])
        .enter().append("stop")
        .attr("offset", function (d) {
            return d.offset;
        })
        .attr("stop-color", function (d) {
            return d.color;
        });

    svg.append("path")
        .datum(maa_df)
        .attr("fill", "none")
        .attr("stroke", "url(#line-gradient)")
        .attr("stroke-width", 2)
        .attr("d", d3.line()
            .x(function (d) {
                return x(d.date)
            })
            .y(function (d) {
                return y(d.count)
            })
        )

    // ********* STACKED BAR CHART **************

    // set the dimensions and margins of the graph
    var margin = {top: 10, right: 30, bottom: 30, left: 60},
        width = 460 - margin.left - margin.right,
        height = 400 - margin.top - margin.bottom;

    // append the svg object to the body of the page
    var svg = d3.select("#genre_count_stacked_monthly")
        .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform",
            "translate(" + margin.left + "," + margin.top + ")");

    // Parse the Data
    var data = JSON.parse('{{ mgc_dict | tojson | safe }}');
    var genres = JSON.parse('{{ mgc_genres | tojson | safe }}');
    console.log(data);
    console.log(genres);

    var subgroups = genres;

    var groups = d3.map(data, function (d) {
        return (d.added_at)
    });


    //data.forEach(function (data) {
    //    data.added_at = d3.timeParse("%m-%Y")(data.added_at)
    //})

    // Add X axis
    var x = d3.scaleBand()
        .domain(groups)
        .range([0, width])
        .padding([0.1])

    console.log(groups);

    //var x = d3.scaleTime().domain(d3.extent(data.map(function (item) {
    //    console.log(item.added_at);
    //    return item.added_at;
    //}))).range([0, width]);


    svg.append("g")
        .attr("transform", "translate(0," + height + ")")
        .call(d3.axisBottom(x).tickSizeOuter(0));

    // Add Y axis
    var y = d3.scaleLinear()
        .domain([0, 110])
        .range([height, 0]);


    svg.append("g")
        .call(d3.axisLeft(y));

    // color palette = one color per subgroup
    //var color = d3.scaleOrdinal()
    //    .domain(subgroups)
    //    .range(['#e41a1c', '#377eb8', '#4daf4a'])

    console.log(d3);
    console.log(d3.version);

    var color = d3.scaleSequential()
	    .domain([0, subgroups.length])
	    .interpolator(d3.interpolateSpectral);

    //stack the data? --> stack per subgroup
    var stackedData = d3.stack()
        .keys(subgroups)
        (data)

    console.log(stackedData);

    // Show the bars
    svg.append("g")
        .selectAll("g")
        // Enter in the stack data = loop key per key = group per group
        .data(stackedData)
        .enter().append("g")
        .attr("fill", function (d) {
            console.log("COLOR");
            console.log(d);
            console.log(color(d.index));
            return color(d.index);
        })
        .selectAll("rect")
        // enter a second time = loop subgroup per subgroup to add all rectangles
        .data(function (d) {
            return d;
        })
        .enter().append("rect")
        .attr("x", function (d) {
            return x(d.data.added_at);
        })
        .attr("y", function (d) {
            return y(d[1]);
        })
        .attr("height", function (d) {
            var ret = y(d[0]) - y(d[1]);
            //console.log("HEIGHT");
            //console.log(d[0]);
            //console.log(d[1]);
            //console.log(y(d[0]));
            //console.log(y(d[1]));
            //console.log(ret);

            if (isNaN(ret)) {
                return 0;
            } else {
                return ret;
            }
        })
        .attr("width", x.bandwidth())


</script>
</body>
</html>